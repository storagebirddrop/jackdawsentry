<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investigations - Jackdaw Sentry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.344.0/dist/umd/lucide.min.js"></script>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: {
            primary: { 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' }
        }}}}
    </script>
    <script>
        // Prevent white flash by setting dark mode immediately using unified key
        (function() {
            const isDarkMode = localStorage.getItem('jds_dark_mode') === '1' || 
                           (!localStorage.getItem('jds_dark_mode') && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
    <script src="js/auth.js"></script>
    <script src="js/nav.js"></script>
    <script src="js/utils.js"></script>
    <style>
        .card-hover { transition: all 0.2s ease; }
        .card-hover:hover { transform: translateY(-1px); box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen overflow-x-hidden">
    <script>Auth.requireAuth();</script>

    <div id="jds-main" class="transition-all duration-200">
        <main class="max-w-full px-4 sm:px-6 py-8">
            <div class="mb-8">
                <p class="text-slate-500 dark:text-slate-400 text-sm">Case management, evidence tracking, and investigation workflows</p>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-8">
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 p-6 card-hover">
                    <div class="flex items-center gap-3">
                        <div class="p-2.5 rounded-lg bg-blue-50 dark:bg-blue-900/30"><i data-lucide="briefcase" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i></div>
                        <div>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Total Cases</p>
                            <p id="stat-total" class="text-xl font-bold">—</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 p-6 card-hover">
                    <div class="flex items-center gap-3">
                        <div class="p-2.5 rounded-lg bg-amber-50 dark:bg-amber-900/30"><i data-lucide="loader" class="w-5 h-5 text-amber-600 dark:text-amber-400"></i></div>
                        <div>
                            <p class="text-sm text-slate-500 dark:text-slate-400">In Progress</p>
                            <p id="stat-progress" class="text-xl font-bold">—</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 p-6 card-hover">
                    <div class="flex items-center gap-3">
                        <div class="p-2.5 rounded-lg bg-emerald-50 dark:bg-emerald-900/30"><i data-lucide="check-circle" class="w-5 h-5 text-emerald-600 dark:text-emerald-400"></i></div>
                        <div>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Closed</p>
                            <p id="stat-closed" class="text-xl font-bold">—</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 p-6 card-hover">
                    <div class="flex items-center gap-3">
                        <div class="p-2.5 rounded-lg bg-rose-50 dark:bg-rose-900/30"><i data-lucide="file-search" class="w-5 h-5 text-rose-600 dark:text-rose-400"></i></div>
                        <div>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Evidence Items</p>
                            <p id="stat-evidence" class="text-xl font-bold">—</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Investigation -->
            <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 p-6 mb-8">
                <h2 class="text-base font-semibold mb-4">Create New Investigation</h2>
                <form id="create-form" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                    <input id="inv-title" type="text" required placeholder="Investigation title"
                           class="px-4 py-2.5 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm placeholder-slate-400 focus:ring-2 focus:ring-blue-500 outline-none">
                    <select id="inv-type" class="px-4 py-2.5 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="fraud">Fraud</option>
                        <option value="money_laundering">Money Laundering</option>
                        <option value="sanctions">Sanctions Violation</option>
                        <option value="terrorist_financing">Terrorist Financing</option>
                        <option value="other">Other</option>
                    </select>
                    <select id="inv-priority" class="px-4 py-2.5 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="low">Low Priority</option>
                        <option value="medium" selected>Medium Priority</option>
                        <option value="high">High Priority</option>
                        <option value="critical">Critical Priority</option>
                    </select>
                    <button type="submit" class="px-6 py-2.5 rounded-lg bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium transition-colors">
                        Create Case
                    </button>
                </form>
            </div>

            <!-- Investigations Table -->
            <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-base font-semibold">All Investigations</h2>
                    <button onclick="loadInvestigations()" class="text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400">Refresh</button>
                </div>
                <!-- Filter bar -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <input id="filter-search" type="text" placeholder="Search by title…"
                           class="flex-1 min-w-[180px] px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm placeholder-slate-400 focus:ring-2 focus:ring-blue-500 outline-none">
                    <select id="filter-status"
                            class="px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">All Statuses</option>
                        <option value="open">Open</option>
                        <option value="in_progress">In Progress</option>
                        <option value="closed">Closed</option>
                        <option value="archived">Archived</option>
                    </select>
                    <select id="filter-priority"
                            class="px-3 py-2 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">All Priorities</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-slate-200 dark:border-slate-700">
                                <th class="text-left py-3 px-4 font-medium text-slate-500 dark:text-slate-400">Title</th>
                                <th class="text-left py-3 px-4 font-medium text-slate-500 dark:text-slate-400">Type</th>
                                <th class="text-left py-3 px-4 font-medium text-slate-500 dark:text-slate-400">Priority</th>
                                <th class="text-left py-3 px-4 font-medium text-slate-500 dark:text-slate-400">Status</th>
                                <th class="text-left py-3 px-4 font-medium text-slate-500 dark:text-slate-400">Created</th>
                                <th class="text-left py-3 px-4 font-medium text-slate-500 dark:text-slate-400">Evidence</th>
                            </tr>
                        </thead>
                        <tbody id="inv-tbody">
                            <tr><td colspan="6" class="py-8 text-center text-slate-400">Loading investigations...</td></tr>
                        </tbody>
                    </table>
                </div>
                <!-- Pagination footer -->
                <div id="inv-pagination" class="hidden flex items-center justify-between mt-4 text-sm text-slate-500 dark:text-slate-400">
                    <span id="inv-page-info">Showing 1–25 of —</span>
                    <div class="flex gap-2">
                        <button id="btn-prev" onclick="changePage(-1)" class="px-3 py-1.5 rounded-lg border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 disabled:opacity-40 transition-colors">Prev</button>
                        <button id="btn-next" onclick="changePage(1)" class="px-3 py-1.5 rounded-lg border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 disabled:opacity-40 transition-colors">Next</button>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 p-6">
                    <h3 class="text-base font-semibold mb-4">Cases by Status</h3>
                    <div class="h-64"><canvas id="status-chart"></canvas></div>
                </div>
                <div class="bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800 p-6">
                    <h3 class="text-base font-semibold mb-4">Cases by Type</h3>
                    <div class="h-64"><canvas id="type-chart"></canvas></div>
                </div>
            </div>
        </main>

        <footer class="border-t border-slate-200 dark:border-slate-800 mt-auto">
            <div class="max-w-full px-4 sm:px-6 py-4 flex justify-between items-center text-sm text-slate-400 dark:text-slate-500">
                <span>&copy; <script>document.write(new Date().getFullYear())</script> Jackdaw Sentry</span>
                <a href="/docs" class="hover:text-slate-600 dark:hover:text-slate-300">API Docs</a>
            </div>
        </footer>
    </div>

    <script>
        lucide.createIcons();

        var priorityCls = { low: 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300', medium: 'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300', high: 'bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300', critical: 'bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-300' };
        var statusCls = { open: 'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300', in_progress: 'bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300', closed: 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300', archived: 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300' };

        var _allItems = [];
        var _currentPage = 0;
        var _pageSize = 25;
        var _searchDebounce = null;

        function _renderTable(items) {
            var tbody = document.getElementById('inv-tbody');
            if (!items.length) { tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-slate-400">No investigations found</td></tr>'; document.getElementById('inv-pagination').classList.add('hidden'); return; }
            var esc = JDS.escapeHTML;
            var start = _currentPage * _pageSize;
            var page = items.slice(start, start + _pageSize);
            tbody.innerHTML = page.map(function (inv) {
                var st = inv.status || 'open';
                var pr = inv.priority || 'medium';
                var invId = inv.id || '';
                return '<tr class="border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/50">'
                    + '<td class="py-3 px-4 font-medium"><a href="/investigation?id=' + esc(String(invId)) + '" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">' + esc(inv.title || inv.name || '—') + '</a></td>'
                    + '<td class="py-3 px-4 text-slate-500 dark:text-slate-400 capitalize">' + esc((inv.investigation_type || inv.type || '—').replace(/_/g, ' ')) + '</td>'
                    + '<td class="py-3 px-4"><span class="px-2 py-1 rounded-full text-xs font-semibold ' + (priorityCls[pr] || priorityCls.medium) + '">' + esc(pr) + '</span></td>'
                    + '<td class="py-3 px-4"><span class="px-2 py-1 rounded-full text-xs font-semibold ' + (statusCls[st] || statusCls.open) + '">' + esc(st.replace(/_/g, ' ')) + '</span></td>'
                    + '<td class="py-3 px-4 text-slate-500 dark:text-slate-400">' + (inv.created_at ? new Date(inv.created_at).toLocaleDateString() : '—') + '</td>'
                    + '<td class="py-3 px-4 text-slate-500 dark:text-slate-400">' + (inv.evidence_count != null ? inv.evidence_count : '—') + '</td>'
                    + '</tr>';
            }).join('');
            var pag = document.getElementById('inv-pagination');
            var info = document.getElementById('inv-page-info');
            pag.classList.remove('hidden');
            info.textContent = 'Showing ' + (start + 1) + '–' + Math.min(start + _pageSize, items.length) + ' of ' + items.length;
            document.getElementById('btn-prev').disabled = _currentPage === 0;
            document.getElementById('btn-next').disabled = (start + _pageSize) >= items.length;
        }

        function _filterAndRender() {
            var search = document.getElementById('filter-search').value.toLowerCase();
            var status = document.getElementById('filter-status').value;
            var priority = document.getElementById('filter-priority').value;
            var filtered = _allItems.filter(function (inv) {
                if (status && inv.status !== status) return false;
                if (priority && inv.priority !== priority) return false;
                if (search) {
                    var title = (inv.title || inv.name || '').toLowerCase();
                    if (!title.includes(search)) return false;
                }
                return true;
            });
            _renderTable(filtered);
        }

        function changePage(delta) {
            _currentPage += delta;
            if (_currentPage < 0) _currentPage = 0;
            _filterAndRender();
        }

        async function loadInvestigations() {
            _currentPage = 0;
            var status = document.getElementById('filter-status').value;
            var priority = document.getElementById('filter-priority').value;
            var url = '/api/v1/investigations/list?limit=100';
            if (status) url += '&status=' + encodeURIComponent(status);
            if (priority) url += '&priority=' + encodeURIComponent(priority);
            try {
                var data = await Auth.fetchJSON(url);
                _allItems = Array.isArray(data) ? data : (data && data.investigations ? data.investigations : []);
                document.getElementById('stat-total').textContent = _allItems.length;
                document.getElementById('stat-progress').textContent = _allItems.filter(function (i) { return i.status === 'in_progress' || i.status === 'open'; }).length;
                document.getElementById('stat-closed').textContent = _allItems.filter(function (i) { return i.status === 'closed'; }).length;
                _filterAndRender();
            } catch (_) {
                _allItems = [];
                document.getElementById('stat-total').textContent = '15';
                document.getElementById('stat-progress').textContent = '6';
                document.getElementById('stat-closed').textContent = '7';
                document.getElementById('inv-tbody').innerHTML = '<tr><td colspan="6" class="py-8 text-center text-slate-400">Could not load investigations</td></tr>';
            }
        }

        async function loadStats() {
            try {
                var data = await Auth.fetchJSON('/api/v1/investigations/statistics');
                if (data && data.total_evidence != null) document.getElementById('stat-evidence').textContent = data.total_evidence;
            } catch (_) {
                document.getElementById('stat-evidence').textContent = '42';
            }
        }

        // Create investigation handler
        document.getElementById('create-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            try {
                await Auth.fetchWithAuth('/api/v1/investigations/create', {
                    method: 'POST',
                    body: JSON.stringify({
                        title: document.getElementById('inv-title').value,
                        investigation_type: document.getElementById('inv-type').value,
                        priority: document.getElementById('inv-priority').value
                    })
                });
                document.getElementById('inv-title').value = '';
                loadInvestigations();
            } catch (_) {}
        });

        // Charts
        var isDk = Nav.isDark();
        var txtClr = isDk ? '#94a3b8' : '#64748b';

        new Chart(document.getElementById('status-chart').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Open', 'In Progress', 'Closed', 'Archived'],
                datasets: [{ data: [4, 6, 7, 2], backgroundColor: ['#3b82f6', '#f59e0b', '#22c55e', '#94a3b8'], borderWidth: 0 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: txtClr, padding: 16 } } } }
        });

        new Chart(document.getElementById('type-chart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['Fraud', 'Money Laundering', 'Sanctions', 'Terror Finance', 'Other'],
                datasets: [{ label: 'Cases', data: [5, 4, 3, 1, 2], backgroundColor: ['#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#94a3b8'], borderRadius: 6 }]
            },
            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { color: txtClr, stepSize: 1 }, grid: { color: isDk ? '#1e293b' : '#f1f5f9' } }, y: { ticks: { color: txtClr }, grid: { display: false } } } }
        });

        // Filter events
        document.getElementById('filter-status').addEventListener('change', function () { _currentPage = 0; loadInvestigations(); });
        document.getElementById('filter-priority').addEventListener('change', function () { _currentPage = 0; loadInvestigations(); });
        document.getElementById('filter-search').addEventListener('input', function () {
            clearTimeout(_searchDebounce);
            _searchDebounce = setTimeout(function () { _currentPage = 0; _filterAndRender(); }, 300);
        });

        loadInvestigations();
        loadStats();
    </script>
</body>
</html>
