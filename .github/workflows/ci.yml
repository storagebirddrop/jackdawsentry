name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
      - run: pip install flake8
      - name: Flake8 (syntax & import errors only)
        run: flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics

  test:
    name: Unit & Smoke Tests
    runs-on: ubuntu-latest
    env:
      TESTING: "true"
      LOG_LEVEL: WARNING
      API_SECRET_KEY: ci-secret-key-for-testing-only-1234
      ENCRYPTION_KEY: ci-encryption-key-32-chars-long!!
      JWT_SECRET_KEY: ci-jwt-secret-key-for-testing-ok
      JWT_ALGORITHM: HS256
      JWT_EXPIRE_MINUTES: "30"
      DATABASE_URL: postgresql://test:test@localhost:5432/test
      NEO4J_URI: bolt://localhost:7687
      REDIS_URL: redis://localhost:6379/1
      API_HOST: "0.0.0.0"
      API_PORT: "8000"
      DEBUG: "true"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
      - name: Install test dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements-test.txt
      - name: Run tests (skip integration)
        run: pytest -m "not integration" --tb=short -q

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image
        run: docker build -f docker/Dockerfile -t jackdawsentry:ci .
